version: '3'

vars:
  BINARY_NAME: qube
  BUILD_DIR: C:/Users/admin/go/bin
  MAIN: ./cmd/qube
  VERSION:
    sh: git describe --tags --abbrev=0 2>/dev/null || echo "dev"

tasks:
  default:
    cmds:
      - task: build

  build:
    desc: ðŸ”§ Build Qube CLI
    cmds:
      - echo "ðŸ”§ Building {{.BINARY_NAME}} version {{.VERSION}}"
      - go build -ldflags="-X github.com/apiqube/cli/cmd/qube.version={{.VERSION}}" -o={{.BUILD_DIR}}/{{.BINARY_NAME}}.exe {{.MAIN}}

  build-versioned:
    desc: ðŸ”§ Build Qube CLI
    cmds:
      - echo "ðŸ”§ Building {{.BINARY_NAME}} version {{.VERSION}}"
      - go build -ldflags="-X github.com/apiqube/cli/cmd/qube.version={{.VERSION}}" -o {{.BUILD_DIR}}/{{.BINARY_NAME}}-{{.VERSION}}.exe {{.MAIN}}

  clean:
    desc: ðŸ§¹ Clean build directory
    cmds:
      - echo "ðŸ§¹ Cleaning..."
      - rm -f {{.BUILD_DIR}}/{{.BINARY_NAME}}.exe

  run:
    desc: ðŸš€ Run CLI
    cmds:
      - ./bin/{{.BINARY_NAME}}.exe

  dev:
    desc: ðŸ‘¨â€ðŸ’» Watch mode (requires reflex or air)
    cmds:
      - reflex -r '\.go$$' -s -- sh -c "task build && task run"

  test:
    desc: Run all tests
    cmds:
      - go test -v -coverpkg=./... -coverprofile=cover.out ./...

  cover:
    desc: Create SVG cover heatmap from cover.out
    cmds:
      - go-cover-treemap -percent=true -w=1080 -h=360 -coverprofile cover.out > cover.svg

  fmt:
    desc: ðŸ§¹ Cleaning all go code
    cmds:
      - gofumpt -l -w .

  lint:
    desc: ðŸš€ Command for linting code
    cmds:
      - golangci-lint run ./...